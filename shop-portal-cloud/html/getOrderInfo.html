<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
    <title>结算页</title>

    <link href="../js/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!--<link rel="stylesheet" href="../js/bootstrap/css/bootstrap.min.css">-->
    <link rel="stylesheet" type="text/css" href="../js/shop/css/webbase.css"/>
    <link rel="stylesheet" type="text/css" href="../js/shop/css/pages-getOrderInfo.css"/>
</head>

<body>
<!--head-->
<div class="top">
    <div class="py-container">
        <div class="shortcut">
            <ul class="fl">
                <li class="f-item">飞狐小超市欢迎您！</li>
                <li class="f-item"><a href="login.html">请登录</a>&nbsp;&nbsp;&nbsp;<span><a
                        href="reg.html">免费注册</a></span></li>
            </ul>
            <ul class="fr">
                <li class="f-item"><a href="orderList.html">我的订单</a></li>
                <li class="f-item space"></li>
                <li class="f-item">我的品优购</li>
                <li class="f-item space"></li>
                <li class="f-item">品优购会员</li>
                <li class="f-item space"></li>
                <li class="f-item">企业采购</li>
                <li class="f-item space"></li>
                <li class="f-item">关注品优购</li>
                <li class="f-item space"></li>
                <li class="f-item">客户服务</li>
                <li class="f-item space"></li>
                <li class="f-item">网站导航</li>
            </ul>
        </div>
    </div>
</div>
<div class="cart py-container">
    <!--logoArea-->
    <div class="logoArea">
        <div class="fl logo"><span class="title">结算页</span></div>
        <div class="fr search">
            <form class="sui-form form-inline">
                <div class="input-append">
                    <input type="text" type="text" class="input-error input-xxlarge" placeholder="品优购自营"/>
                    <button class="sui-btn btn-xlarge btn-danger" type="button">搜索</button>
                </div>
            </form>
        </div>
    </div>
    <!--主内容-->
    <div class="checkout py-container">
        <div class="checkout-tit">
            <h4 class="tit-txt">填写并核对订单信息</h4>
        </div>
        <div class="checkout-steps">
            <!--收件人信息-->
            <div class="step-tit">
                <h5>收件人信息
                    <span><a data-toggle="modal" data-target=".edit" data-keyboard="false" onclick="addAddress()"
                             class="newadd">新增收货地址</a></span></h5>
                </h5>
            </div>
            <div class="step-cont">
                <div class="addressInfo">
                    <ul class="addr-detail">
                        <li class="addr-item" id="addressBigDiv">

                        </li>
                    </ul>
                    <!--确认地址-->
                </div>
                <div class="hr"></div>

            </div>
            <div class="hr"></div>
            <!--支付和送货-->
            <div class="payshipInfo">
                <div class="step-tit">
                    <h5>支付方式</h5>
                </div>
                <div class="step-cont">
                    <ul class="payType">
                        <li class="selected" name="payType" value="1">微信付款<span title="点击取消选择"></span></li>
                        <li name="payType" value="2">支付宝付款<span title="点击取消选择"></span></li>
                    </ul>
                </div>
                <div class="hr"></div>
                <div class="step-tit">
                    <h5>送货清单</h5>
                </div>
                <div class="step-cont">
                    <ul class="send-detail" id="sendDivBig">

                    </ul>
                </div>
                <div class="hr"></div>
            </div>
            <div class="linkInfo">
                <div class="step-tit">
                    <h5>发票信息</h5>
                </div>
                <div class="step-cont">
                    <span>普通发票（电子）</span>
                    <span>个人</span>
                    <span>明细</span>
                </div>
            </div>
            <div class="cardInfo">
                <div class="step-tit">
                    <h5>使用优惠/抵用</h5>
                </div>
            </div>
        </div>
    </div>
    <div class="order-summary">
        <div class="static fr">
            <div class="list">
                <span><i class="number" id="totalCount"></i>件商品，总商品金额</span>
                <em class="allprice" id="totalPrices"></em>
            </div>
            <div class="list">
                <span>返现：</span>
                <em class="money">0.00</em>
            </div>
            <div class="list">
                <span>运费：</span>
                <em class="transport">0.00</em>
            </div>
        </div>
    </div>
    <div class="clearfix trade">
        <div class="fc-price">应付金额:　<span class="price" id="totalPrice"></span></div>
        <div class="fc-receiverInfo" id="addrDiv"></div>
    </div>
    <div class="submit">
        <a class="sui-btn btn-danger btn-xlarge" href="#" onclick="submitOrder()">提交订单</a>
    </div>
</div>
<!-- 底部栏位 -->
<!--页面底部-->
<div class="clearfix footer">
    <div class="py-container">
        <div class="footlink">
            <div class="Mod-service">
                <ul class="Mod-Service-list">
                    <li class="grid-service-item intro  intro1">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro2">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro  intro3">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item  intro intro4">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                    <li class="grid-service-item intro intro5">

                        <i class="serivce-item fl"></i>
                        <div class="service-text">
                            <h4>正品保障</h4>
                            <p>正品保障，提供发票</p>
                        </div>

                    </li>
                </ul>
            </div>
            <div class="clearfix Mod-list">
                <div class="yui3-g">
                    <div class="yui3-u-1-6">
                        <h4>购物指南</h4>
                        <ul class="unstyled">
                            <li>购物流程</li>
                            <li>会员介绍</li>
                            <li>生活旅行/团购</li>
                            <li>常见问题</li>
                            <li>购物指南</li>
                        </ul>

                    </div>
                    <div class="yui3-u-1-6">
                        <h4>配送方式</h4>
                        <ul class="unstyled">
                            <li>上门自提</li>
                            <li>211限时达</li>
                            <li>配送服务查询</li>
                            <li>配送费收取标准</li>
                            <li>海外配送</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>支付方式</h4>
                        <ul class="unstyled">
                            <li>货到付款</li>
                            <li>在线支付</li>
                            <li>分期付款</li>
                            <li>邮局汇款</li>
                            <li>公司转账</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>售后服务</h4>
                        <ul class="unstyled">
                            <li>售后政策</li>
                            <li>价格保护</li>
                            <li>退款说明</li>
                            <li>返修/退换货</li>
                            <li>取消订单</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                        <h4>特色服务</h4>
                        <ul class="unstyled">
                            <li>夺宝岛</li>
                            <li>DIY装机</li>
                            <li>延保服务</li>
                            <li>品优购E卡</li>
                            <li>品优购通信</li>
                        </ul>
                    </div>
                    <div class="yui3-u-1-6">
                    </div>
                </div>
            </div>
            <div class="Mod-copyright">
                <ul class="helpLink">
                    <li>关于我们<span class="space"></span></li>
                    <li>联系我们<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>商家入驻<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们<span class="space"></span></li>
                    <li>营销中心<span class="space"></span></li>
                    <li>友情链接<span class="space"></span></li>
                    <li>关于我们</li>
                </ul>
            </div>
        </div>
    </div>
</div>
<!--页面底部END-->

<div id="recipientDiv" style="display: none;">
    <form class="form-horizontal">
        <div class="form-group">
            <label class="col-sm-2 control-label">收件人:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="add_recipient" placeholder="请输入收件人">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">收件地址:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="add_address" placeholder="请输入收件地址">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">联系方式:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="add_phone" placeholder="请输入联系方式">
            </div>
        </div>
        <div style="text-align: center;">
        </div>
    </form>
</div>
<div id="addressInfo" style="display: none">
    <div>
        <div class="con name ##status##" onclick="updateStatus('##id##')">
            <a href="javascript:;">##recipient##<span title="点击取消选择">&nbsp;</a></div>
        <div class="con address" onclick="changeInfo('##id##',this)">##recipient##&nbsp;
            ##address##<span>##phone##</span>
            <!--<span class="base">默认地址</span>-->
            ##delfult##
            <span style="display: none"><a onclick="updateRecipient('##id##')">编辑</a>&nbsp;&nbsp;<a href="javascript:;"
                                                                                                    onclick="deleteRecip('##id##')">删除</a></span>
        </div>
        <div class="clearfix"></div>
    </div>
</div>
<div id="sendGoods" style="display: none">
    <li>
        <div>
            <ul class="yui3-g">
                <li class="yui3-u-1-6">
                    <span><img src="##skuImage##" style="width: 50px;height: 50px"/></span>
                </li>
                <li class="yui3-u-7-12">
                    <div class="desc">##skuName##</div>
                    <div class="seven">7天无理由退货</div>
                </li>
                <li class="yui3-u-1-12">
                    <div class="price">￥ ##subPrice##</div>
                </li>
                <li class="yui3-u-1-12">
                    <div class="num">X ##count##</div>
                </li>
                <li class="yui3-u-1-12">
                    <div class="exit">有货</div>
                </li>
            </ul>
        </div>
    </li>
</div>
<div id="reciUpdateDiv" style="display: none">
    <form class="form-horizontal">
        <div class="form-group">
            <label class="col-sm-2 control-label">收件人:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="edit_recipient">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">收件地址:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="edit_address">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-2 control-label">联系方式:</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="edit_phone">
            </div>
        </div>
        <div style="text-align: center;">
        </div>
    </form>
</div>

<script src="../js/jquery-3.3.1.js"></script>
<!--<script type="text/javascript" src="../js/shop/js/plugins/jquery/jquery.min.js"></script>-->
<script type="text/javascript" src="../js/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="../js/shop/js/plugins/sui/sui.min.js"></script>
<script type="text/javascript" src="../js/shop/js/pages/getOrderInfo.js"></script>
<script src="../js/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../js/bootbox/bootbox.locales.min.js"></script>
<script type="text/javascript" src="../js/bootbox/bootbox.min.js"></script>
<script type="text/javascript" src="../js/common.js"></script>
<script src="../js/jquery.cookie.min.js"></script>
</body>
<style type="text/css">

</style>
<script>

    $(function () {
        //收件人
        initList();
        //购物车订单
        initCart();

        createToken();
    })

    var x_token;

    function createToken() {
        $.ajax({
            type: "post",
            url: server_url + "/tokens/createToken?",
            beforeSend: function (xhr) {
                var cookie = $.cookie(TOKEN);
                xhr.setRequestHeader(AUTH, cookie);
                xhr.setRequestHeader(XTOKEN, x_token);
            },
            success: function (res) {
                if (res.code == 200) {
                    console.log(res.data)
                    x_token = res.data;
                }
            }
        })
    }

    function updateStatus(id) {
        $.ajax({
            type: "post",
            url: server_url + "/recipient/updateStatus",
            data: {"id": id},
            beforeSend: function (xhr) {
                var cookie = $.cookie(TOKEN);
                xhr.setRequestHeader(AUTH, cookie);
            },
            "success": function (res) {
                if (res.code == 200) {
                    initList();
                } else {
                    alert(res.msg)
                }
            }
        })
    }

    function initEvent() {
        $(".con.address").hover(function () {
            $(this).children().last().show();
        }, function () {
            $(this).children().last().hide();
        })
    }

    function initCart() {
        $.ajax({
            type: "get",
            url: server_url + "/cart/findCart",
            beforeSend: function (xhr) {
                var cookie = $.cookie(TOKEN);
                xhr.setRequestHeader(AUTH, cookie);
            },
            success: function (res) {
                if (res.code == 200) {
                    // 购物车不为空，直接显示内容
                    // console.log(res.data);
                    var v_cartItemVoList = res.data.cartItemVoList;
                    var v_totalCount = res.data.totalCount;
                    var v_totalPrice = res.data.totalPrice;
                    var v_replace = "";
                    var v_cartItemHtml = $("#sendGoods").html();
                    for (let i = 0; i < v_cartItemVoList.length; i++) {
                        var v_item = v_cartItemVoList[i];
                        v_replace += v_cartItemHtml.replace(/##skuImage##/g, v_item.image)
                            .replace(/##skuName##/g, v_item.skuName)
                            .replace(/##count##/g, v_item.count)
                            .replace(/##subPrice##/g, v_item.subPrice);
                    }
                    $("#sendDivBig").append(v_replace);
                    $("#totalCount").html(v_totalCount)
                    $("#totalPrices").html(v_totalPrice)
                    $("#totalPrice").html(v_totalPrice)
                    var v_result = $("#goodsTotal").html().replace(/##totalCount##/g, v_totalCount)
                        .replace(/##totalPrice##/g, v_totalPrice);
                    $("#Goods").html(v_result);
                    $("#GoodsAddressDiv").html($("#finalDiv").html().replace(/##totalPrice##/g, v_totalPrice))

                } else if (res.code == 5102 || res.code == 5100 || res.code == 5101) {
                    location.href = "login.html"
                }
            }
        })
    }

    var infoList;
    var v_slectedItem;

    function initList() {
        $.ajax({
            type: "get",
            url: server_url + "/recipient/findList",
            beforeSend: function (xhr) {
                var cookie = $.cookie(TOKEN);
                xhr.setRequestHeader(AUTH, cookie);
            },
            "success": function (res) {
                console.log(res.data)
                if (res.code == 200) {
                    infoList = res.data;
                    var v_replace = "";
                    var v_cartItemHtml = $("#addressInfo").html();
                    for (let i = 0; i < infoList.length; i++) {
                        var v_item = infoList[i];
                        var v_phone = v_item.phone;
                        var start = v_phone.substring(0, 3);
                        var over = v_phone.substring(7, 11);
                        var aa = "****";
                        var phone = start + aa + over;
                        v_replace += v_cartItemHtml.replace(/##recipient##/g, v_item.recipientName)
                            .replace(/##address##/g, v_item.address)
                            .replace(/##id##/g, v_item.id)
                            .replace(/##status##/g, v_item.status == 1 ? "selected" : "")
                            .replace(/##delfult##/g, v_item.status == 1 ? '<span class="base">默认地址</span>' : "")
                            .replace(/##phone##/g, phone);
                        if (v_item.status == 1) {
                            v_slectedItem = v_item;
                            $("#addrDiv").html("寄送至:" + v_item.address + " 收货人：" + v_item.recipientName + "  " + phone)

                            // v_addrDivHtml=replace(/##recipientid##/g, v_item.id)
                        }
                    }
                    $("#addressBigDiv").html(v_replace);
                    initEvent();
                }

            }
        })
    }

    function changeInfo(id, obj) {
        for (let v_item of infoList) {
            var v_phone = v_item.phone;
            var start = v_phone.substring(0, 3);
            var over = v_phone.substring(7, 11);
            var aa = "****";
            var phone = start + aa + over;
            if (id == v_item.id) {
                v_slectedItem = v_item;
                $("#addrDiv").html("寄送至:" + v_item.address + " 收货人：" + v_item.recipientName + "  " + phone)
            }
        }
        //重置
        $(".con.address").css("font-weight", "")
        //设置
        $(obj).css("font-weight", "bold")
    }

    function addAddress() {
        //备份
        var v_recipient = $("#recipientDiv").html();
        //弹框
        var v_recipientDiv = bootbox.dialog({
            title: "添加",
            message: $("#recipientDiv form"),
            size: "middle",
            buttons: {
                confirm: {
                    label: '确认',
                    className: 'btn-primary',
                    callback: function () {
                        //获取参数
                        var param = {};
                        param.recipientName = $("#add_recipient", v_recipientDiv).val();
                        param.address = $("#add_address", v_recipientDiv).val();
                        param.phone = $("#add_phone", v_recipientDiv).val();
                        //发送ajax请求
                        $.ajax({
                            type: "post",
                            data: param,
                            url: server_url + "/recipient/add",
                            beforeSend: function (xhr) {
                                var cookie = $.cookie(TOKEN);
                                xhr.setRequestHeader(AUTH, cookie);
                            },
                            "success": function (result) {
                                if (result.code == 200) {
                                    initList();
                                }

                            }
                        })
                    }
                },
                cancel: {
                    label: '取消',
                    className: 'btn-danger'
                }
            }
        });
        //还原
        $("#recipientDiv").html(v_recipient);
    }

    function updateRecipient(id) {
        $.ajax({
            type: "get",
            data: {"id": id},
            url: server_url + "/recipient/findById",
            beforeSend: function (xhr) {
                var cookie = $.cookie(TOKEN);
                xhr.setRequestHeader(AUTH, cookie);
            },
            success: function (res) {
                if (res.code == 200) {
                    // 回显数据
                    $("#edit_recipient").val(res.data.recipientName)
                    $("#edit_address").val(res.data.address)
                    $("#edit_phone").val(res.data.phone)

                    // 备份
                    var v_Html = $("#reciUpdateDiv").html();
                    // 渲染
                    //弹框
                    var v_editDialog = bootbox.dialog({
                        title: "修改品牌",
                        message: $("#reciUpdateDiv form"),
                        size: "middle",
                        buttons: {
                            confirm: {
                                label: '确认',
                                className: 'btn-primary progress-bar-striped',
                                callback: function () {
                                    //获取参数
                                    var param = {};
                                    param.id = id;
                                    param.recipientName = $("#edit_recipient", v_editDialog).val();
                                    param.address = $("#edit_address", v_editDialog).val();
                                    param.phone = $("#edit_phone", v_editDialog).val();
                                    $.ajax({
                                        type: "put",
                                        data: JSON.stringify(param),
                                        contentType: "application/json",
                                        beforeSend: function (xhr) {
                                            var cookie = $.cookie(TOKEN);
                                            xhr.setRequestHeader(AUTH, cookie);
                                        },
                                        url: server_url + "/recipient/updateAddress",
                                        success: function (result) {
                                            if (result.code == 200) {
                                                initList();
                                            }

                                        }
                                    })
                                }
                            },
                            cancel: {
                                label: '取消',
                                className: 'btn-danger progress-bar-striped'
                            }
                        }
                    });
                    //还原
                    $("#reciUpdateDiv").html(v_Html);
                }
            }
        })
    }

    //进行删除操作
    function deleteRecip(id) {
        $.ajax({
            type: "delete",
            url: server_url + "/recipient/deleteAddress/?id=" + id,
            beforeSend: function (xhr) {
                var cookie = $.cookie(TOKEN);
                xhr.setRequestHeader(AUTH, cookie);
            },
            success: function (result) {
                if (result.code == 200) {
                    initList();
                }
            }
        })
    }

    function submitOrder() {
        // var recipientId = $("#recipientId").val();
        // // var value = $("li[name=payType]").valueOf();
        // var value = $("li[name=payType]").get(0).getAttribute("value");
        // console.log(recipientId);
        // console.log(value);
        var recipientId = v_slectedItem.id;
        if (recipientId == null) {
            alert("请选择收件人")
        }

        $.ajax({
            type: "post",
            url: server_url + "/orders/addOrder",
            data: {"recipientId": recipientId, payType: 0},
            beforeSend: function (xhr) {
                var cookie = $.cookie(TOKEN);
                xhr.setRequestHeader(AUTH, cookie);
                xhr.setRequestHeader(XTOKEN, x_token);
            },
            success: function (res) {
                if (res.code == 200) {
                    location.href = "orderList.html";
                } else {
                    alert(res.msg)
                }
            }
        })
    }
</script>

</html>